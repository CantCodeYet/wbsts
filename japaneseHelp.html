<html>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <head>
    	<meta name="mobile-web-app-capable" content="yes">
    	<title>Japanese alphabets test</title>
        <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script-->
        <link rel="stylesheet" href="res/bootstrap.css">
        <!--script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script-->
        <style>
            *{
                outline: none;
            }
            .title{
                text-align: center;
            }

            .flashcard{
                font-size: 15rem;
                text-align: center;
                user-select: none;
            }

            .button{
                text-align: center;
                border-radius: 1rem;
            }

            select, option{
                text-transform: capitalize;
            }

            .button:hover{
                background-color: #343a40!important;
                color: #f8f9fa;
            }
            thead tr:nth-child(1) th{background: white; position: sticky;top: 0;z-index: 10;}
            .table-responsive{max-height:50vh; overflow:auto;} 
        </style>
        <script>
            let panes = {started: undefined, before: undefined, buttonBar: undefined, statsPane: undefined};
            let inputs = {inVocali: undefined, inConsonanti: undefined, selectAlphabet: undefined};
            let outputs = {flashcard: undefined, statistiche: undefined};
            let exceptions = {"si": "shi", "zi": "ji", "ti":"chi", "tu":"tsu", "di":"dji", "du":"dzu", "hu":"fu"};
            let ExtraHiragana = {
                "n":"„Çì",
                "a":"„ÅÇ","i":"„ÅÑ","u":"„ÅÜ","e":"„Åà","o":"„Åä",
                "ka":"„Åã","ki":"„Åç","ku":"„Åè","ke":"„Åë","ko":"„Åì",
                "ga":"„Åå","gi":"„Åé","gu":"„Åê","ge":"„Åí","go":"„Åî",
                "sa":"„Åï","shi":"„Åó","su":"„Åô","se":"„Åõ","so":"„Åù",
                "za":"„Åñ","ji":"„Åò","zu":"„Åö","ze":"„Åú","zo":"„Åû",
                "ta":"„Åü","chi":"„Å°","tsu":"„Å§","te":"„Å¶","to":"„Å®",
                "da":"„Å†","dji":"„Å¢","dzu":"„Å•","de":"„Åß","do":"„Å©",
                "na":"„Å™","ni":"„Å´","nu":"„Å¨","ne":"„Å≠","no":"„ÅÆ",
                "ha":"„ÅØ","hi":"„Å≤","fu":"„Åµ","he":"„Å∏","ho":"„Åª",
                "ba":"„Å∞","bi":"„Å≥","bu":"„Å∂","be":"„Åπ","bo":"„Åº",
                "pa":"„Å±","pi":"„Å¥","pu":"„Å∑","pe":"„Å∫","po":"„ÅΩ",
                "ma":"„Åæ","mi":"„Åø","mu":"„ÇÄ","me":"„ÇÅ","mo":"„ÇÇ",
                "ya":"„ÇÑ","yu":"„ÇÜ","yo":"„Çà",
                "ra":"„Çâ","ri":"„Çä","ru":"„Çã","re":"„Çå","ro":"„Çç",
                "wa":"„Çè","wi":"„Çê","we":"„Çë","wo":"„Çí"
            };
            let extraKatakana = {
                "n":"„É≥",
                "a":"„Ç¢","i":"„Ç§","u":"„Ç¶","e":"„Ç®","o":"„Ç™",
                "ka":"„Ç´","ki":"„Ç≠","ku":"„ÇØ","ke":"„Ç±","ko":"„Ç≥",
                "ga":"„Ç¨","gi":"„ÇÆ","gu":"„Ç∞","ge":"„Ç≤","go":"„Ç¥",
                "sa":"„Çµ","shi":"„Ç∑","su":"„Çπ","se":"„Çª","so":"„ÇΩ",
                "za":"„Ç∂","ji":"„Ç∏","zu":"„Ç∫","ze":"„Çº","zo":"„Çæ",
                "ta":"„Çø","chi":"„ÉÅ","tsu":"„ÉÑ","te":"„ÉÜ","to":"„Éà",
                "da":"„ÉÄ","dji":"„ÉÇ","dzu":"„ÉÖ","de":"„Éá","do":"„Éâ",
                "na":"„Éä","ni":"„Éã","nu":"„Éå","ne":"„Éç","no":"„Éé",
                "ha":"„Éè","hi":"„Éí","fu":"„Éï","he":"„Éò","ho":"„Éõ",
                "ba":"„Éê","bi":"„Éì","bu":"„Éñ","be":"„Éô","bo":"„Éú",
                "pa":"„Éë","pi":"„Éî","pu":"„Éó","pe":"„Éö","po":"„Éù",
                "ma":"„Éû","mi":"„Éü","mu":"„É†","me":"„É°","mo":"„É¢",
                "ya":"„É§","yi":"","yu":"„É¶","ye":"Ì†¨Ì∞Ä","yo":"„É®",
                "ra":"„É©","ri":"„É™","ru":"„É´","re":"„É¨","ro":"„É≠",
                "wa":"„ÉØ","wi":"„É∞","wu":"","we":"„É±","wo":"„É≤"
            };
            let hiragana = {
                "n":"„Çì",
                "a":"„ÅÇ","i":"„ÅÑ","u":"„ÅÜ","e":"„Åà","o":"„Åä",
                "ka":"„Åã","ki":"„Åç","ku":"„Åè","ke":"„Åë","ko":"„Åì",
                "ga":"„Åå","gi":"„Åé","gu":"„Åê","ge":"„Åí","go":"„Åî",
                "sa":"„Åï","shi":"„Åó","su":"„Åô","se":"„Åõ","so":"„Åù",
                "za":"„Åñ","ji":"„Åò","zu":"„Åö","ze":"„Åú","zo":"„Åû",
                "ta":"„Åü","chi":"„Å°","tsu":"„Å§","te":"„Å¶","to":"„Å®",
                "da":"„Å†","dji":"„Å¢","dzu":"„Å•","de":"„Åß","do":"„Å©",
                "na":"„Å™","ni":"„Å´","nu":"„Å¨","ne":"„Å≠","no":"„ÅÆ",
                "ha":"„ÅØ","hi":"„Å≤","fu":"„Åµ","he":"„Å∏","ho":"„Åª",
                "ba":"„Å∞","bi":"„Å≥","bu":"„Å∂","be":"„Åπ","bo":"„Åº",
                "pa":"„Å±","pi":"„Å¥","pu":"„Å∑","pe":"„Å∫","po":"„ÅΩ",
                "ma":"„Åæ","mi":"„Åø","mu":"„ÇÄ","me":"„ÇÅ","mo":"„ÇÇ",
                "ya":"„ÇÑ","yu":"„ÇÜ","yo":"„Çà",
                "ra":"„Çâ","ri":"„Çä","ru":"„Çã","re":"„Çå","ro":"„Çç",
                "wa":"„Çè","wo":"„Çí"
            };
            let katakana = {
                "n":"„É≥",
                "a":"„Ç¢","i":"„Ç§","u":"„Ç¶","e":"„Ç®","o":"„Ç™",
                "ka":"„Ç´","ki":"„Ç≠","ku":"„ÇØ","ke":"„Ç±","ko":"„Ç≥",
                "ga":"„Ç¨","gi":"„ÇÆ","gu":"„Ç∞","ge":"„Ç≤","go":"„Ç¥",
                "sa":"„Çµ","shi":"„Ç∑","su":"„Çπ","se":"„Çª","so":"„ÇΩ",
                "za":"„Ç∂","ji":"„Ç∏","zu":"„Ç∫","ze":"„Çº","zo":"„Çæ",
                "ta":"„Çø","chi":"„ÉÅ","tsu":"„ÉÑ","te":"„ÉÜ","to":"„Éà",
                "da":"„ÉÄ","dji":"„ÉÇ","dzu":"„ÉÖ","de":"„Éá","do":"„Éâ",
                "na":"„Éä","ni":"„Éã","nu":"„Éå","ne":"„Éç","no":"„Éé",
                "ha":"„Éè","hi":"„Éí","fu":"„Éï","he":"„Éò","ho":"„Éõ",
                "ba":"„Éê","bi":"„Éì","bu":"„Éñ","be":"„Éô","bo":"„Éú",
                "pa":"„Éë","pi":"„Éî","pu":"„Éó","pe":"„Éö","po":"„Éù",
                "ma":"„Éû","mi":"„Éü","mu":"„É†","me":"„É°","mo":"„É¢",
                "ya":"„É§","yu":"„É¶","yo":"„É®",
                "ra":"„É©","ri":"„É™","ru":"„É´","re":"„É¨","ro":"„É≠",
                "wa":"„ÉØ","wo":"„É≤"
            };
            let alphabets = {hiragana, katakana};
            let vowels = [" ", "a", "i", "u", "e", "o"];
            let consonants = [" ", "k", "g", "s", "z", "t", "d", "n", "h", "b", "p", "m", "y", "r", "w"];
            let allowed = [];
            let statistics;
            let statisticsAlphabet = "hiragana";
            let state = {
                shown: false,
                actual: "",
                japSide: false,
                alphabet: "hiragana"
            }
            let alphabet = alphabets[state.alphabet];

            Object.prototype.forEach = function(callback){Object.keys(this).forEach(k => {callback(k, this[k])})};

            function loadStatistics(){
                statistics = window.localStorage.getItem("japStats");
                if(!statistics){
                    statistics = {hiragana: {}, katakana: {}};
                    Object.keys(alphabet).forEach(key => {
                        statistics.hiragana[key] = {correct: 0, error:0, last: undefined};
                        statistics.katakana[key] = {correct: 0, error:0, last: undefined};
                    });
                }else{
                    statistics = JSON.parse(statistics);
                }
            }

            function resetStatistics(){
                window.localStorage.removeItem("japStats");
                loadStatistics();
                fillStatsTable();
            }

            function swapStatisticsAlphabet(){
                if(statisticsAlphabet === "hiragana"){
                    statisticsAlphabet = "katakana";
                }else if(statisticsAlphabet === "katakana"){
                    statisticsAlphabet = "hiragana";
                }else{
                    window.location.reload();
                }
                fillStatsTable();
            }

            function loadElementsOf(obj){
                Object.keys(obj).forEach(key => {
                    obj[key] = document.getElementById(key);
                });
            }

            function saveStatistics(){
                window.localStorage.setItem("japStats", JSON.stringify(statistics));
            }

            function loaded(){
                loadStatistics();
                window.addEventListener("beforeunload", saveStatistics);
                loadElementsOf(panes);
                loadElementsOf(inputs);
                loadElementsOf(outputs);
                allConsonants();
                allVowels();
            }

            function pickIndex(len){
                return Math.floor(Math.random() * len);
            }

            function pickFromArray(arr){
                return arr[pickIndex(arr.length)];
            }

            function advancedPick(arr){
                if(!arr.picked){
                    arr.picked = [];
                    for(let i = 0; i < arr.length; i++){
                        arr.picked[i] = 0;
                    }
                    let index = pickIndex(arr.length);
                    arr.picked[index]++;
                    arr.picked.max = 1;
                    return arr[index];
                }
                if(arr.picked.length !== arr.length){
                    arr.picked = undefined;
                    return advancedPick(arr);
                }
                let pickChance = [];
                let sum = 0;
                for(let i = 0; i < arr.length; i++){
                    pickChance[i] = (arr.picked.max - arr.picked[i]) * 3 + 1;
                    sum += pickChance[i];
                }
                let index = pickIndex(sum);
                sum = 0;
                let i;
                for(i = 0; i < arr.length; i++){
                    sum += pickChance[i];
                    if(index < sum)
                        break;
                }
                let lastUpdatedIndex = ++arr.picked[i];
                if(lastUpdatedIndex > arr.picked.max)
                    arr.picked.max = lastUpdatedIndex;
                return arr[i];
            }

            function fillStatsTable(){

                outputs.statistiche.innerHTML = "";
                statistics[statisticsAlphabet].forEach((k,v) => {
                    let total = v.correct + v.error;
                    let percentage = (v.correct / total * 100).toFixed(2);
                    let newRow = outputs.statistiche.insertRow();
                    let headCell = newRow.insertCell();
                    headCell.outerHTML = "<th>" + k + "</th>";
                    headCell = newRow.insertCell();
                    headCell.outerHTML = "<th>" + alphabets[statisticsAlphabet][k] + "</th>";
                    newRow.insertCell().innerHTML = v.correct;
                    newRow.insertCell().innerHTML = v.error;
                    newRow.insertCell().innerHTML = total;
                    newRow.insertCell().innerHTML = isNaN(percentage) ? "" : percentage + "%";
                    newRow.insertCell().innerHTML = v.last ? v.last.correct ? "Corretto" : "Errato" : "";
                });
            }

            function showPane(pane){
                Object.keys(panes).forEach(key => {panes[key].hidden = true;})
                pane.hidden = false;
            }

            function startButton(){
                state.alphabet = inputs.selectAlphabet.value;
                alphabet = alphabets[state.alphabet];
                allowed = [];
                let allowedVowels = inputs.inVocali.value.toLowerCase();
                let allowedConsonants = inputs.inConsonanti.value.toLowerCase();
                for(let i = 0; i < allowedVowels.length; i++){
                    for(let j = 0; j < allowedConsonants.length; j++){
                        let res = allowedConsonants[j] + allowedVowels[i];
                        res = res.trim();
                        res = exceptions[res] ? exceptions[res] : res;
                        if(alphabet[res])
                            allowed.push(res);
                    }
                }
                setupNewFlashcardState();
                showPane(panes.started);
            }

            function correctButton(){
                statistics[state.alphabet][state.actual].correct += 1;
                statistics[state.alphabet][state.actual].last = {correct: true};
                setupNewFlashcardState();
            }

            function errorButton(){
                statistics[state.alphabet][state.actual].error += 1;
                statistics[state.alphabet][state.actual].last = {correct:false};
                setupNewFlashcardState();
            }

            function flashCard(){
                state.shown |= true;
                state.japSide = !state.japSide;
            }

            function statsButton(){
                fillStatsTable();
                showPane(panes.statsPane);
            }

            function setupNewFlashcardState(){
                state.shown = false;
                state.actual = advancedPick(allowed);
                state.japSide = false;
            }

            function updateView(){
                panes.buttonBar.hidden = !state.shown;
                outputs.flashcard.innerHTML = state.japSide ? alphabet[state.actual] : state.actual; 
            }

            function allVowels(){
                inputs.inVocali.value = vowels.join("");
            }

            function allConsonants(){
                inputs.inConsonanti.value = consonants.join("");
            }

            /*
            function test(tests, iterationPerTest){
                function basePickWithStats(arr){
                    if(!arr.picked){
                        arr.picked = [];
                        for(let i = 0; i < arr.length; i++){
                            arr.picked[i] = 0;
                        }
                        arr.picked.max = 0;
                    }
                    let i = pickIndex(arr.length);
                    let lastUpdatedIndex = ++arr.picked[i];
                    if(lastUpdatedIndex > arr.picked.max)
                        arr.picked.max = lastUpdatedIndex;
                    return arr[i];
                }

                function minMaxMapper(arr){
                    let min = arr[0];
                    let max = arr[0];
                    for(let i = 1; i < arr.length; i++){
                        if(arr[i] > max) max = arr[i];
                        if(arr[i] < min) min = arr[i];
                    }
                    return {min, max};
                }

                function avgMinMax(arr){
                    let minSum = 0, maxSum = 0;
                    for(let i = 0; i < arr.length; i++){
                        minSum += arr[i].min;
                        maxSum += arr[i].max;
                    }
                    return {minAvg: minSum / arr.length, maxAvg: maxSum / arr.length};
                }

                if(!tests) tests = 100;
                if(!iterationPerTest) iterationPerTest = 1000;
                
                let testRes = {};

                testRes.baseResults = [];
                testRes.advaResults = [];
                for(let i = 0; i < tests; i++){
                    allowed.picked = undefined;
                    for(let i = 0; i < iterationPerTest; i++)
                        basePickWithStats(allowed);
                        testRes.baseResults.push(allowed.picked);
                    allowed.picked = undefined;
                    for(let i = 0; i < iterationPerTest; i++)
                        advancedPick(allowed);
                    testRes.advaResults.push(allowed.picked);
                }

                
                testRes.baseMinMax = testRes.baseResults.map(minMaxMapper);
                testRes.advaMinMax = testRes.advaResults.map(minMaxMapper);
                testRes.baseMinMaxAvg = avgMinMax(testRes.baseMinMax);
                testRes.advaMinMaxAvg = avgMinMax(testRes.advaMinMax);
                return testRes;
            }*/


        </script>
    </head>
    <body onload="loaded();">
        <div class="container-fluid" onclick="updateView()">
            <div class="row my-5">
                <div class="col-md">
                    <h1 class="title" onclick="showPane(panes.before);">Japanese Alphabets Test</h1>
                </div>
            </div>
            <div id="started" hidden>
                <div class="row justify-content-center">
                    <div onclick="flashCard();" id="flashcard" class="col-md-6 flashcard border bg-light">
                        „Åã
                    </div>
                </div>
                <div id="buttonBar" class="row justify-content-center mt-5" hidden>
                    <div class="col-md-2 m1 text-center">
                        <button type="button" class="btn btn-success" onclick="correctButton();">Corretto</button>
                    </div>
                    <div class="col-md-2 m1 text-center">
                        <button type="button" class="btn btn-danger" onclick="errorButton();">Errato</button>
                    </div>
                </div>
            </div>
            <div id="before">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                              <label class="input-group-text" for="inputGroupSelect01">Options</label>
                            </div>
                            <select class="custom-select" id="selectAlphabet">
                                <option value="hiragana">hiragana</option>
                                <option value="katakana">katakana</option>
                            </select>
                          </div>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                            <span class="input-group-text">Vocali</span>
                            </div>
                            <input id="inVocali" type="text" class="form-control">
                            <div class="input-group-append">
                                <button class="btn btn-secondary" onclick="allVowels();" type="button" id="button-addon2">Tutte</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Consonanti</span>
                            </div>
                            <input id="inConsonanti" type="text" class="form-control">
                            <div class="input-group-append">
                                <button class="btn btn-secondary" onclick="allConsonants();" type="button" id="button-addon2">Tutte</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-2"></div>
                    <div class="col-md-4 text-center">
                        <button type="button" class="btn btn-primary" onclick="startButton();">Inizia</button>
                    </div>
                    <div class="col-md-2 text-center">
                        <button type="button" class="btn btn-outline-secondary" onclick="statsButton();">Statistiche</button>
                    </div>
                </div>
            </div>
            <div id="statsPane" hidden>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive border">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>#</th>
                                        <th>Corrette</th>
                                        <th>Errate</th>
                                        <th>Totali</th>
                                        <th>%Corrette</th>
                                        <th>Ultimo</th>
                                    </tr>
                                </thead>
                                <tbody id="statistiche">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-5 text-left mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="swapStatisticsAlphabet()">Cambia alfabeto</button>
                    </div>
                    <div class="col-md-5 text-right mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetStatistics();">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>